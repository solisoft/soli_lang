<div class="max-w-3xl mx-auto">
    <div class="mb-16">
        <h1 class="text-4xl font-bold tracking-tight text-white sm:text-5xl mb-6">
            <span class="bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">Middleware</span>
        </h1>
        <p class="text-xl text-gray-300 leading-8">
            Filter HTTP requests and responses. Middleware enables cross-cutting concerns like authentication, logging, and CORS handling.
        </p>
    </div>

    <h2 class="text-2xl font-bold text-white mb-6">Middleware Attributes</h2>
    <p class="text-gray-400 mb-6">Control behavior using special comment attributes:</p>

    <div class="rounded-xl bg-gray-950 ring-1 ring-white/10 overflow-hidden shadow-xl mb-12">
        <div class="px-4 py-2 border-b border-white/5 bg-white/5 flex items-center justify-between">
            <span class="text-xs text-gray-400 font-mono">app/middleware/logging.soli</span>
        </div>
        <div class="p-4 overflow-x-auto">
<pre><code class="language-soli text-sm">// order: 10
// Execution order (lower runs first, default: 100)
fn log_request(req: Any) -> Any {
    let timestamp = datetime::now();
    println(timestamp + " " + req.method + " " + req.path);
    return req;
}

// global_only: true
// Only run when applied globally
fn cors(req: Any) -> Any {
    let response = req;
    response.headers["Access-Control-Allow-Origin"] = "*";
    return response;
}

// scope_only: true
// Only run when explicitly scoped
fn authenticate(req: Any) -> Any {
    let token = req.headers["Authorization"];
    if token == null { return error(401, "Unauthorized"); }
    return req;
}</code></pre>
        </div>
    </div>

    <h2 class="text-2xl font-bold text-white mb-6">Creating Middleware</h2>

    <div class="rounded-xl bg-gray-950 ring-1 ring-white/10 overflow-hidden shadow-xl mb-12">
        <div class="px-4 py-2 border-b border-white/5 bg-white/5 flex items-center justify-between">
            <span class="text-xs text-gray-400 font-mono">app/middleware/auth.soli</span>
        </div>
        <div class="p-4 overflow-x-auto">
<pre><code class="language-soli text-sm">// order: 20
// scope_only: true
fn authenticate(req: Any) -> Any {
    let token = req.headers["Authorization"];

    if token == null || token == "" {
        return error(401, "Unauthorized");
    }

    // Validate token
    let user = validate_token(token);
    if user == null {
        return error(401, "Invalid token");
    }

    // Attach user to request
    req["user"] = user;
    return req;
}</code></pre>
        </div>
    </div>

    <h2 class="text-2xl font-bold text-white mb-6">Execution Order</h2>
    <p class="text-gray-400 mb-8">Requests flow through middleware layers before reaching your controller.</p>

    <div class="relative py-8 mb-16">
        <div class="absolute left-1/2 top-0 bottom-0 w-px bg-gradient-to-b from-transparent via-indigo-500/50 to-transparent -translate-x-1/2"></div>
        
        <div class="space-y-4">
            <!-- Step 1 -->
            <div class="relative flex items-center justify-center">
                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-indigo-500 ring-4 ring-gray-950"></div>
                <div class="bg-gray-900 border border-white/10 rounded-lg px-6 py-3 shadow-lg">
                    <span class="text-indigo-400 font-mono text-xs block mb-1">Step 1</span>
                    <span class="text-white font-medium">Global Middleware</span>
                    <span class="text-gray-500 text-sm ml-2">(Sorted by order)</span>
                </div>
            </div>

            <div class="h-8"></div>

            <!-- Step 2 -->
            <div class="relative flex items-center justify-center">
                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-purple-500 ring-4 ring-gray-950"></div>
                <div class="bg-gray-900 border border-white/10 rounded-lg px-6 py-3 shadow-lg">
                    <span class="text-purple-400 font-mono text-xs block mb-1">Step 2</span>
                    <span class="text-white font-medium">Scoped Middleware</span>
                    <span class="text-gray-500 text-sm ml-2">(Specific to route)</span>
                </div>
            </div>

            <div class="h-8"></div>

            <!-- Step 3 -->
            <div class="relative flex items-center justify-center">
                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-green-500 ring-4 ring-gray-950"></div>
                <div class="bg-green-500/10 border border-green-500/20 rounded-lg px-6 py-3 shadow-lg">
                    <span class="text-green-400 font-mono text-xs block mb-1">Target</span>
                    <span class="text-white font-bold">Controller Action</span>
                </div>
            </div>

            <div class="h-8"></div>

            <!-- Step 4 -->
            <div class="relative flex items-center justify-center">
                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-gray-500 ring-4 ring-gray-950"></div>
                <div class="bg-gray-900 border border-white/10 rounded-lg px-6 py-3 shadow-lg">
                    <span class="text-gray-400 font-mono text-xs block mb-1">Return</span>
                    <span class="text-white font-medium">Response flows back up</span>
                </div>
            </div>
        </div>
    </div>

    <h2 class="text-2xl font-bold text-white mb-6">Applying Middleware</h2>
    
    <div class="rounded-xl bg-gray-950 ring-1 ring-white/10 overflow-hidden shadow-xl mb-12">
        <div class="px-4 py-2 border-b border-white/5 bg-white/5 flex items-center justify-between">
            <span class="text-xs text-gray-400 font-mono">config/routes.soli</span>
        </div>
        <div class="p-4 overflow-x-auto">
<pre><code class="language-soli text-sm">// Global middleware (runs on every request)
use("middleware/logging");
use("middleware/cors");

// Scoped middleware (runs on specific routes)
get("/dashboard", "dashboard#index", ["auth"]);

// Combining scopes
get("/api/users", "api#users", ["auth", "rate_limit"]);</code></pre>
        </div>
    </div>

    <div class="my-8 p-6 rounded-xl bg-indigo-500/10 border border-indigo-500/20 mb-12">
        <h4 class="text-lg font-semibold text-indigo-400 mb-2 flex items-center gap-2">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.854 1.5-2.269a6.002 6.002 0 00-2.25-10.428m0 0a6.002 6.002 0 012.25-10.428M14.25 18a6.002 6.002 0 01-2.25 10.428m2.25-10.428v-.192c0-.983-.658-1.854-1.5-2.269" />
            </svg>
            Best Practices
        </h4>
        <ul class="text-indigo-200/80 space-y-2 mt-2 text-sm">
            <li>• Use <code>order</code> to strictly control the execution sequence.</li>
            <li>• Keep global middleware lightweight; expensive operations belong in scoped middleware.</li>
            <li>• Use <code>scope_only: true</code> for authentication to prevent accidental global application.</li>
        </ul>
    </div>

    <h2 class="text-2xl font-bold text-white mb-6">Next Steps</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="/docs/controllers" class="group block p-6 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50 transition-all">
            <h3 class="text-lg font-semibold text-white mb-2 group-hover:text-indigo-400 transition-colors">Controllers &rarr;</h3>
            <p class="text-sm text-gray-400">Handle the requests processed by middleware.</p>
        </a>
        <a href="/docs/views" class="group block p-6 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50 transition-all">
            <h3 class="text-lg font-semibold text-white mb-2 group-hover:text-indigo-400 transition-colors">Views &rarr;</h3>
            <p class="text-sm text-gray-400">Render HTML responses for your users.</p>
        </a>
        <a href="/docs/models" class="group block p-6 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50 transition-all">
            <h3 class="text-lg font-semibold text-white mb-2 group-hover:text-indigo-400 transition-colors">Models &rarr;</h3>
            <p class="text-sm text-gray-400">Interact with your database securely.</p>
        </a>
    </div>
</div>
